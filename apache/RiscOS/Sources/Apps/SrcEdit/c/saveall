/* Copyright 2007 Castle Technology Ltd
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* File:    saveall.c
 * Purpose: saving and closing all named edits
 * Author:  IDJ
 * History: 25-Mar-90: IDJ: Created
 *          IDJ: 15-Dec-94: bug fix AQU-00524: check for untitled before trying to save
 *                          to file (ie s->filename[0] != 0)
 *
 *
 */

/*  OUTSTANDING
     what do we do with <untitled>'s
*/

#include "txtedit.h"
#include "txt.h"
#include "typdat.h"
#include "os.h"
#include "msgs.h"
#include "werr.h"
#include "wimpt.h"

#include "saveall.h"


static int saveall__dosave(txt t, char *filename, typdat ty)
{

   int n, result;
   char *a;
   os_filestr file;
   txt_index wasat;

   txt_setcharoptions(t, txt_DISPLAY, 0);
   wasat = txt_dot(t);
   txt_setdot(t, 0);
   txt_arrayseg(t, 0, &a, &n);

   file.action = 0;
   file.name = filename;
   file.loadaddr = ty.ld;
   file.execaddr = ty.ex;
   file.start = (int) &a[0];
   file.end = (int) &a[n];
   result = wimpt_complain(os_file(&file)) == 0;

   txt_setdot(t, wasat);
   txt_setdisplayok(t);

   return(result);
}


static void saveall__buildnewtimestamp(typdat oldty, typdat *newty)
{
   int block[2];
   /* ignore call if untyped, thus preserving Load/Exec addresses */
   if (((unsigned int)oldty.ld >> 20) >= 0xfff) /* it's got a type ! */
   {
       block[0] = 3;
       os_word(14, &block);
       newty->ld = ((unsigned int) oldty.ld & 0xffffff00) + (block[1] & 0xff);
       newty->ex = block[0];
   }
   else
   {
       newty->ld = oldty.ld;
       newty->ex = oldty.ex;
   }
}


static  BOOL saveall__save_and_close_it(txtedit_state *s)
{
   typdat newty;

   /* IDJ: 15-Dec-94: bug fix AQU-00524: check for untitled before trying to save
    *                 to file (ie s->filename[0] != 0)
    */
   if (txt_UPDATED & txt_charoptions(s->t) && s->filename[0] != 0)
     saveall__buildnewtimestamp(s->ty, &newty);
   else
   {
     txtedit_dispose(s); 
     return TRUE;
   }

   if (saveall__dosave(s->t, s->filename, newty))
   {
     txtedit_dispose(s); 
     return TRUE;
   }
   else
   {
     werr(FALSE, msgs_lookup("txt2: Could not save file '%s'"), s->filename);
     return FALSE;
   }
}


extern void saveall_savethem(void) 
{
   txtedit_state *s;
   int untitled_found = FALSE;

   /* IDJ: 15-Dec-94: bug fix AQU-00524: check for untitled before trying to save
    *                 to file (ie s->filename[0] != 0)
    */

   /* go through saving each state */
   s = txtedit_getstates();
   while (s != 0)
   {
      if (s->filename[0] == 0)
          untitled_found = TRUE;
      else
          saveall__save_and_close_it(s);
      s = s->next ;
   }

   if (untitled_found)
       werr(FALSE, msgs_lookup("saveall1:Some untitled documents were found during 'save all'"));
}
