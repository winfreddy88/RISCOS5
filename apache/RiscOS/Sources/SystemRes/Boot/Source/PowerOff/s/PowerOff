; Copyright 2002 Tematic Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
        GET     Hdr:ListOpts
        GET     Hdr:Macros
        GET     Hdr:System
        GET     Hdr:Proc

;;-----------------------------------------------------------------------------
;; A transient to forceably turn off the power (if available)
;;-----------------------------------------------------------------------------

PowerDownFeature *      1<<3       ; ReadSysInfo 8 bit of interest
PowerDownMagic   *      &46464F26  ; OS_Reset '&OFF'

        AREA    PowerOff, CODE, READONLY

PowerOffTransient
        Push    "r0-r2"
        MOV     r0, #8
        SWI     XOS_ReadSysInfo         ; See whether we capable of softpowerdown
        MOVVS   r1, #0                  ; ReadSysInfo 8 not supported
        AND     r0, r1, r2              ; Bits set that are relevant
        CLRV
        TST     r0, #PowerDownFeature
        Pull    "r0-r2",EQ              ; We can't power off,so exit doing nothing
        MOVEQ   pc, r14
        LDR     r0, =PowerDownMagic
        SWI     XOS_Reset
        B       .                       ; Incase the capacitors hold us up for a bit longer
        LTORG
        END
