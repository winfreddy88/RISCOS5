/* Copyright 1996 Acorn Computers Ltd
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
#include <stdio.h>
#include "swis.h"
#include "Global/OsBytes.h"
#include "Global/CMOS.h"

#define PreDeskConfigFile "<PreDesk$Configure>"
#define PreDeskMonitorLine 1

int main (void)
{
        int value;

        _swix( OS_Byte, _INR(0,1) | _OUT(2), OsByte_ReadCMOS, SystemSpeedCMOS, &value );
        if ( value & CMOSResetBit )
        {
                FILE *ufile;

                ufile = fopen( PreDeskConfigFile, "r+" );
                if ( ufile != NULL )
                {
                        int dcount = PreDeskMonitorLine;
                        int inchar = '\n';

                        do
                        {
                                if ( inchar == '\n' )
                                {
                                        --dcount;
                                        if ( dcount <= 0 )
                                        {
                                                fseek( ufile, 0, SEEK_CUR );
                                                fputc( '|', ufile );
                                                fseek( ufile, 0, SEEK_CUR );
                                        }
                                }
                        }
                        while ( (dcount > -1) && ((inchar = fgetc( ufile )) != EOF) );
                        fclose( ufile );
                }
#if 0
                /* SMC: LoadModeFile is in a different file now so don't do this anymore. */
                /*
                        This catches the LoadModeFile command in the obey -c buffer
                        The |M|| at the end is to catch the auto-appendation
                        of the unused parameters
                */
                _swix( OS_CLI, _IN(0), "Alias LoadModeFile UnAlias LoadModeFile|M||" );
#endif
        }

        return 0;
}
