; Copyright 2016 Castle Technology Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;

        AREA    |Asm$$Data|,DATA,READWRITE
DMBWrPtr DCD    0

        AREA    |Asm$$Code|,CODE,READONLY

        GET     ListOpts
        GET     Macros
        GET     System
        GET     OSMisc
        GET     Hdr:SCSI
;
;
;        EXPORT  asm_ReadDMB
;        EXPORT  asm_DMBInit
;
;; insert DMBWrite pointer in supplied pointer
;asm_DMBInit
;        STMFD   R13!, {R0,R4-R11,LR}
;        LDR     R0, =(ARMop_DMB_Write:SHL:8)+MMUCReason_GetARMop
;        SWI     XOS_MMUControl
;        ADRVS   R0, My_DMB_Write        ; old kernel?
;        LDR     LR, [r13], #4
;        STR     R0, [LR]
;        LDMFD   R13!, {R4-R11,PC}
;
;My_DMB_Write
;        DMB     ST
;        MOV     pc, lr
;asm_ReadDMB
;        DMB
;        mov     pc, lr


        EXPORT  asm_Inquiry
; Do a SCSI Inquiry command as a sort of 'noop'
; on entry r0 = SCSI ID, r1 -> 36 byte buffer
; on exit if r0 = NULL then r1 filled in
; if error r0 -> error block
; timeout is 1 second
asm_Inquiry
        Push   "r1-r12,lr"
        MOV     R3, R1
        ORR     R0, R0, #&01000000
        MOV     R1, #6
        ADR     R2, CDB_Inquiry
        MOV     R4, #36
        MOV     R5, #100
        MOV     R8, #&fc000003          ; magic access key
        SWI     XSCSI_Op
        MOVVC   r0, #0
        Pull    "r1-r12,pc"
CDB_Inquiry
        DCB     &12                     ; INQUIRY
        DCB     0
        DCB     0
        DCB     0
        DCB     36
        DCB     0
        ALIGN

        EXPORT  asm_ReadCapacity
; Do a SCSI ReadCapacity command
; on entry r0 = SCSI ID, r1 -> 8 byte buffer
; on exit if r0 = NULL then buffer filled in
; if error r0 -> error block
; timeout is .75 second
asm_ReadCapacity
        Push   "r1-r12,lr"
        MOV     R3, R1
        ORR     R0, R0, #&01000000
        MOV     R1, #10
        ADR     R2, CDB_ReadCapacity
        MOV     R4, #8
        MOV     R5, #75
        MOV     R8, #&fc000003          ; magic access key
        SWI     XSCSI_Op
        MOVVC   r0, #0
        Pull    "r1-r12,pc"
CDB_ReadCapacity
        DCB     &25                     ; ReadCapacity
        DCB     0
        DCB     0
        DCB     0
        DCB     0
        DCB     0
        DCB     0
        DCB     0
        DCB     8
        DCB     0
        ALIGN

        END
